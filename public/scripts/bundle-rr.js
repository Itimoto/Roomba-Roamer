!function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)i.d(s,n,function(e){return t[e]}.bind(null,n));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);class s{constructor(t){t.x?this.x=t.x:this.x=0,t.y?this.y=t.y:this.y=0,t.width?this.width=t.width:this.width=0,t.height?this.height=t.height:this.height=0,t.color?this.color=t.color:this.color="white",t.xVel?this.xVel=t.xVel:this.xVel=0,t.yVel?this.yVel=t.yVel:this.yVel=0,this.BASE={x:this.x,y:this.y},t.bounds&&(this.bounds=t.bounds),t.objArr&&t.objArr.push(this),t.isFlipped?this.isFlipped=t.isFlipped:this.isFlipped=!1}update(){let t=this.isFlipped?this.yVel:this.xVel,e=this.isFlipped?this.xVel:this.yVel;this.bounds&&(this.xVel<0&&this.x<0&&(t=0),this.xVel>0&&this.x+this.width>this.bounds.width&&(t=0),this.yVel<0&&this.y<0&&(e=0),this.yVel>0&&this.y+this.height>this.bounds.height&&(e=0)),this.y+=e,this.x+=t}draw(t){t.fillStyle=this.color,this.isFlipped?t.fillRect(this.y,this.x,this.height,this.width):t.fillRect(this.x,this.y,this.width,this.height)}onCollision(t){t.yVel*=-1}}class n extends s{constructor(t){super(t),this.color="green",this.bounds&&(this.width=this.bounds.height/20,this.height=this.bounds.height)}}class r extends s{constructor(t){super(t),this.PLAYERVELOCITY=5,this.pts=0,this.bounds&&(this.width=this.bounds.height/40,this.height=this.bounds.height/5),this.onCollision=this.onCollision.bind(this)}onCollision(t){t.xVel*=-1.05,t.yVel+=Math.round(this.yVel/4*Math.random())+this.yVel/2}changeVel(t){"UP"!=t&&"ArrowUp"!=t||(this.yVel=-1*this.PLAYERVELOCITY),"DOWN"!=t&&"ArrowDown"!=t||(this.yVel=this.PLAYERVELOCITY),"STOP"==t&&(this.yVel=0)}}class h extends s{constructor(t){super(t),t.radius?this.radius=t.radius:this.radius=30,t.maxVel?this.maxVel=t.maxVel:this.maxVel=3,this.bounds&&(this.x=this.bounds.width/2,this.y=this.bounds.height/2,this.radius=this.bounds.height/50)}draw(t){t.beginPath(),this.isFlipped?t.arc(this.y,this.x,this.radius,0,2*Math.PI):t.arc(this.x,this.y,this.radius,0,2*Math.PI),t.fillStyle=this.color,t.fill()}genXVel(t){t&&(this.maxVel=t),this.xVel=this.maxVel*(2-4*Math.round(Math.random()))}}let o,a,l;let d;class c{constructor(t,e){o=t.getContext("2d"),o.imageSmoothingEnabled=!1,l=e,d=window.getComputedStyle(document.body).getPropertyValue("background-color"),this.orientation=e.orientation||"wide","narrow"==this.orientation&&(u.start=u.start_narrow,u.score=u.score_narrow),this.changeScreen("start")}render(){window.requestAnimationFrame(this.renderState)}changeScreen(t,e){this.renderState=u[t]||e||this.renderState,this.currStateName=t,g(this.renderState,50,o)}superimpose(t,e){let{isObj:i}=e,s=this.renderState;this.renderState=function(){s(),i?t.draw(o):t(o)},this.changeScreen(null,this.renderState)}startRenderingGame(){this.renderState=this.renderGame,this.changeScreen(),a=setInterval(this.renderGame,10)}stopRenderingGame(){clearInterval(a)}clearScreen(){let t=o.canvas;o.clearRect(0,0,t.width,t.height),o.fillStyle=d,o.fillRect(0,0,t.width,t.height)}renderGame(){let{genConstants:t,gameObjects:e,bounds:i}=l;if(null==t)return clearInterval(a),void console.log("Renderer improperly ended.");o.fillStyle=d,o.fillRect(0,0,o.canvas.width,o.canvas.height),u.score(t.player1.pts,t.player2.pts,o.canvas.width/2,i.height/6,o),e.forEach(t=>{t.draw(o)})}}let u={start:()=>{let t,e,i=o.canvas,{player:s}=l;o.fillStyle=d,o.fillRect(0,0,i.width,i.height),o.fillStyle="white",o.font="30px 'Press Start 2P'",o.fillText("WELCOME TO",i.width/2-o.measureText("Welcome to").width/2,i.height/4),o.font=i.height/4*.9+"px 'Press Start 2P'",o.font=f("PONG",3*i.width/5,o),o.fillText("PONG",i.width/2-o.measureText("PONG").width/2,i.height/2),"player1"==s?(t="YOU",e="WAITING"):"player2"==s?(t="WAITING",e="YOU"):t=e="QUEUING",o.font="30px 'Press Start 2P'";let n={headerX:i.width*(1/3.5)-o.measureText("PLAYER1:").width/2,headerY:i.height/1.7,statusX:i.width*(1/3.5)-o.measureText(t).width/2,statusY:i.height/1.53},r={headerX:i.width*(1-1/3.5)-o.measureText("PLAYER2:").width/2,headerY:n.headerY,statusX:i.width*(1-1/3.5)-o.measureText(e).width/2,statusY:n.statusY};o.fillRect(i.width*(1/3.5)/2,0,2,i.height),o.fillRect(i.width*(1-1/3.5/2),0,2,i.height),o.fillText("PLAYER1:",n.headerX,n.headerY),o.fillText("PLAYER2:",r.headerX,r.headerY),o.fillStyle="QUEUING"==t?"#a88070":"#6f9656",o.fillText(t,n.statusX,n.statusY),o.fillText(e,r.statusX,r.statusY)},score(t,e,i,s,n){let{genConstants:r,bounds:h}=l;if(n.fillStyle="white",n.font="40px 'Press Start 2P'",n.fillText(t,i-60,s),n.fillText(e,i+25,s),n.fillRect(i,0,2,1e3),t>=9){let t=i-(r.player1.x+r.player1.width);t*=.9,n.font=f("P1 Wins!",h.width/3,n);let e=parseInt(n.font.split(" ")[0]);n.fillText("P1 Wins!",i-t,3*s+e/2)}if(e>=9){n.font=f("P2 Wins!",h.width/3,n);let t=parseInt(n.font.split(" ")[0]);n.fillText("P2 Wins!",i+(h.width/2-n.measureText("P2 Wins!").width)/3,3*s+t/2)}},help:()=>{let{canvas:t,orientation:e}=l;o.fillStyle=d,o.fillRect(0,0,t.width,t.height);let i=t.width*(1/3.5)/2,s=t.width*(1-1/3.5/2),n=t.width*(1-1/3.5);o.fillStyle="white",o.fillRect(i,0,2,t.height),o.fillRect(s,0,2,t.height),o.font="60px 'Press Start 2P'",o.fillText("PONG",t.width/2-o.measureText("PONG").width/2,t.height/5),o.font="40px 'Press Start 2P'",o.fillStyle="#709455",o.fillText("HELP",t.width/2-o.measureText("PONG").width/2,1*t.height/3);let r=1*t.height/3;o.fillRect(i,r,n,2),o.fillRect(i,r-1.2*parseInt(o.font.split(" ")[0]),n,2);let h=["Pong's a simple game, eh? "," ","Move your paddle to stop the ball from hitting your goal ","If you hit the ball while moving the paddle, the ball will change direction ","wide"==e?"Player 1's on the Left, P2 on the Right ":"Player 1's on Bottom, P2 on Top "," ","wide"==e?"If you're on Desktop.. ":"If you're on Mobile.. ","wide"==e?"Use the Up/Down Arrow Keys to move your paddle ":"Tap the Left half of the screen to move left ","wide"==e?"  ":"and the Right half to move right "," ","If START's been Green for a while, hit REQUEUE to be paired with someone else "];o.font="12px 'Press Start 2P'",o.fillStyle="white";let a=function(t,e,i){if(i>=t.length&&"string"!=typeof t)return t;let s,n="string"==typeof t?t:t[i],r=n.indexOf(" ")>0&&" "!=n[n.length-1];if(!(o.measureText(n).width>e||r))return"string"==typeof t?n:a(t,e,i+1);if(s=a(n.substring(0,n.length-1),e,n.length-1),"string"==typeof t)return s;let h=t.slice(),l=n.substring(s.length,n.length);return h.splice(i,1,s,l),a(h,e,i+1)};h=a(h,s-i,0);let c=(t.height-r)/(h.length+2);c>1.7*p()&&(c=1.7*p()),h.forEach((t,e)=>{let n=w(t,i,s),h=r+(e+2)*c;o.fillText(t,n,h)})},start_narrow:()=>{let t,e,i=o.canvas,{player:s,bounds:n}=l;o.fillStyle=d,o.fillRect(0,0,i.width,i.height),o.fillStyle="white",o.font="20px 'Press Start 2P'",o.fillText("WELCOME TO",i.width/2-o.measureText("Welcome to").width/2,i.height/7),o.font="100px 'Press Start 2P'",o.font=f("PONG",3*i.width/5,o),o.fillText("PONG",i.width/2-o.measureText("PONG").width/2,i.height/3),"player1"==s?(t="YOU",e="WAITING"):"player2"==s?(t="WAITING",e="YOU"):t=e="QUEUING",o.font="20px 'Press Start 2P'";let r={headerX:2*i.width/5-o.measureText("PLAYER1:").width/2,headerY:3*i.height/7,statusX:2*i.width/5-o.measureText(t).width/2,statusY:3*i.height/7+i.height/20},h={headerX:3*i.width/5-o.measureText("PLAYER2:").width/2,headerY:1.4*r.headerY,statusX:3*i.width/5-o.measureText(e).width/2,statusY:1.4*r.headerY+i.height/20};o.fillRect(i.width*(1/3.5)/2,0,2,i.height),o.fillRect(i.width*(1-1/3.5/2),0,2,i.height),o.fillText("PLAYER1:",r.headerX,r.headerY),o.fillText("PLAYER2:",h.headerX,h.headerY),o.fillStyle="QUEUING"==t?"#a88070":"#6f9656",o.fillText(t,r.statusX,r.statusY),o.fillText(e,h.statusX,h.statusY)},score_narrow(t,e,i,s,n){let{offsetY:r,bounds:h}=l;n.fillStyle="white",n.font="40px 'Press Start 2P'",n.fillText(t,1*n.canvas.width/5-30,n.canvas.height/2-20),n.fillText(e,4*n.canvas.width/5,n.canvas.height/2+60),n.fillRect(0,n.canvas.height/2,1e3,2),t>=9&&(n.font=f("P1 Wins!",n.canvas.width/1.1,n),n.fillText("P1 Wins!",n.canvas.width/2-n.measureText("P1 Wins!").width/2,n.canvas.height/2+r-h.width/4+20)),e>=9&&(n.font=f("P2 Wins!",n.canvas.width/1.1,n),n.fillText("P2 Wins!",n.canvas.width/2-n.measureText("P2 Wins!").width/2,n.canvas.height/2+r+h.width/4+20))}},g=function(t,e,i){let s,n=1,r=function(){s=window.requestAnimationFrame(r),e>0?(i.save(),i.globalAlpha=n,i.restore(),i.globalAlpha=1-n,t(),n-=1/e,e--):cancelAnimationFrame(s)};r()},f=function(t,e,i){if(i.measureText(t).width<=e)return i.font;let s=i.font,n=parseInt(s.split(" ")[0]);n-=5;let r=i.font.substring(s.split(" ")[0].length,s.length);return i.font=n+"px"+r,f(t,e,i)},w=function(t,e,i){let s=o.measureText(t).width;return e+(Math.abs(i-e)-s)/2},p=function(){return parseInt(o.font.split(" ")[0])};class m{constructor(t,e){this.canvas=t,this.canvasBounds=t.getBoundingClientRect(),this.x=e.x||0,this.y=e.y||0,this.width=e.width||160,this.height=e.height||90,this.bgOFF=e.bgOFF||"#525461",this.bgACTIVE=e.bgACTIVE||"#202336",this.bgCLICKED=e.bgCLICKED||"#709455",this.bgColor=this.bgOFF,this.fontOFF=e.fontOFF||"#aeb0b8",this.fontACTIVE=e.fontACTIVE||"white",this.fontCLICKED=e.fontCLICKED||this.fontACTIVE,this.font=e.font||"Lato, Serifa, 'Times New Roman'",this.fontSize=e.fontSize||this.width/8+"px",this.fontColor=this.fontOFF,this.textOFF=e.textOFF||"INACTIVE",this.textACTIVE=e.textACTIVE||"START",this.text=e.text||this.textOFF,this.isClicked=!1,this.onClicked=this.onClicked.bind(this),this.callbacks=[]}addClickListener(t,e){let i=()=>{t(),e&&e.once&&this.removeClickListener(i)};this.bgColor=this.bgACTIVE,this.fontColor=this.fontACTIVE,this.text=this.textACTIVE,this.canvas.addEventListener("mousedown",this.onClicked),this.callbacks.push(i)}removeClickListener(t){if(this.canvas.removeEventListener("mousedown",this.onClicked),t);else for(;this.callbacks.length>0;){this.callbacks.pop()}this.bgColor=this.bgOFF,this.fontColor=this.fontOFF}onClicked(t){t.clientX>this.x&&t.clientX<=this.x+this.width&&t.clientY>this.y&&t.clientY<=this.y+this.height&&(this.callbacks.forEach(t=>{t()}),this.bgColor=this.bgCLICKED,this.fontColor=this.fontCLICKED)}setUI(t){"off"==t?(this.bgColor=this.bgOFF,this.fontColor=this.fontOFF):"ready"==t||"active"==t?(this.bgColor=this.bgACTIVE,this.fontColor=this.fontACTIVE):"clicked"==t&&(this.bgColor=this.bgCLICKED,this.fontColor=this.bgCLICKED)}getCursorPos(t){return{x:this.canvasBounds.left+this.width/2-t.clientX,y:this.canvas.top+this.height/2-t.clientY}}draw(t){t.fillStyle=this.bgColor,t.fillRect(this.x,this.y,this.width,this.height),t.fillStyle=this.fontColor,t.font=this.fontSize+" "+this.font;let e=t.measureText(this.text).width,i=parseInt(this.fontSize,10);t.fillText(this.text,this.x+(this.width-e)/2,this.y+(this.height+i/1)/2)}}let y,v,b,E={ArrowUp:!0,ArrowDown:!0};function T(t){y.send(`PG INPUT ${v} ${t}`)}function x(t){let e;if("wide"==b){e=t.touches[0].clientY<=window.innerHeight/2?"ArrowUp":"ArrowDown"}else{e=t.touches[0].clientX<=window.innerWidth/2?"ArrowUp":"ArrowDown"}T(e)}function C(t){T("STOP")}function S(t){E[t.code]&&(E[t.code]=!1,T(t.code))}function P(t){"ArrowUp"!=t.code&&"ArrowDown"!=t.code||(E[t.code]=!0,T("STOP"))}let I,L=[],A=0;function R(t){let e=t.data.split(" ");if("PG"==e[0])if("END"==e[1])console.log("Endgame");else{let t=JSON.parse(e[1]);L.push(t),I||(I=t.time,A=Date.now());let i=B();i>0&&L.splice(0,i)}}function B(){let t=O();for(let e=L.length-1;e>=0;e--)if(L[e].time<=t)return e;return-1}function O(){return I+(Date.now()-A)-100}class _{constructor(t,e,i){this.canvas=t,this.socket=e,this.gameoverEvent=new Event("gameover"),this.gameOver=!1,this.bounds={},i&&i.mobile&&(this.touchInterface=!0),this.initStartScreen=this.initStartScreen.bind(this),this.initBoundaries=this.initBoundaries.bind(this),this.startGame=this.startGame.bind(this),this.update=this.update.bind(this),window.innerWidth>window.innerHeight?(this.orientation="wide",this.localBounds={width:t.width,height:t.height}):(this.orientation="narrow",this.localBounds={width:t.height,height:t.width}),this.renderer=new c(this.canvas,this),this.initStartScreen(this.canvas)}initStartScreen(t){let e=this;e.startButton=new m(t,{x:"wide"==this.orientation?t.width/2-t.width/11:t.width/2-t.width/6,y:"wide"==this.orientation?8.5*t.height/11:7.2*t.height/10,width:"wide"==this.orientation?t.width/5.5:t.width/3,height:"wide"==this.orientation?t.height/15:t.height/16,text:"WAITING",textACTIVE:"START",font:"'Press Start 2P"}),e.requeueButton=new m(t,{x:"wide"==this.orientation?e.startButton.x-1.2*e.startButton.width:e.startButton.x,y:"wide"==this.orientation?e.startButton.y:e.startButton.y+1.3*e.startButton.height,width:e.startButton.width,height:e.startButton.height,text:"REQUEUE",textACTIVE:"REQUEUE",font:"'Press Start 2P"}),e.helpButton=new m(t,{x:"wide"==this.orientation?e.startButton.x+1.2*e.startButton.width:e.startButton.x,y:"wide"==this.orientation?e.startButton.y:e.startButton.y+1.3*e.startButton.height*2,width:e.startButton.width,height:e.startButton.height,text:"HELP",textACTIVE:"HELP",font:"'Press Start 2P"}),e.helpButton.addClickListener((function t(){console.log("Help clicked"),e.helpButton.removeClickListener();let i=new m(e.canvas,(({x:t,y:e,width:i,height:s,font:n})=>({x:t,y:e,width:i,height:s,font:n}))(e.helpButton));i.textACTIVE="BACK",i.addClickListener(()=>{e.helpButton.addClickListener(t),e.renderer.changeScreen("start"),e.renderer.superimpose(e.startButton,{isObj:!0}),e.renderer.superimpose(e.helpButton,{isObj:!0}),e.renderer.superimpose(e.requeueButton,{isObj:!0})},{once:!0}),e.renderer.changeScreen("help"),e.renderer.superimpose(i,{isObj:!0})})),e.renderer.superimpose(e.startButton,{isObj:!0}),e.renderer.superimpose(e.helpButton,{isObj:!0}),e.renderer.superimpose(e.requeueButton,{isObj:!0}),console.log("SENDING REQPONG - INTERNAL"),e.socket.send("ReqPong");let i=!1;setTimeout(()=>{i||e.endGame()},2e4),e.serverReady=function(t){let s=t.data.split(" ");"PG"==s[0]&&"ASSIGN"==s[1]?(i=!0,e.player=s[2],e.startButton.addClickListener(()=>{e.socket.send("PG INITDATA "+JSON.stringify(e.localBounds)),e.socket.addEventListener("message",e.initBoundaries),e.renderer.render()},{once:!0}),e.requeueButton.addClickListener(()=>{e.requestEndGame()},{once:!0}),e.renderer.render()):"PG"==s[0]&&"END"==s[1]&&(e.socket.removeEventListener("message",e.serverReady),e.endGame())},e.socket.addEventListener("message",e.serverReady)}initBoundaries(t){let e=t.data.split(" ");if("PG"==e[0])if("NEWBOUNDS"==e[1]){let t=JSON.parse(e[2]);this.aspectRatio=t,this.bounds.width=this.aspectRatio*this.localBounds.height,this.bounds.height=this.localBounds.height,this.genConstants=function(t){let e={},i=[];return e.ball=new h({bounds:t,objArr:i}),e.topBound=new s({x:0,y:-100,width:t.width,height:100,color:"#00000000",objArr:i}),e.botBound=new s({x:0,y:t.height,width:t.width,height:100,objArr:i}),e.leftGoal=new n({bounds:t,objArr:i}),e.rightGoal=new n({x:t.width-e.leftGoal.width,bounds:t,objArr:i}),e.player1=new r({x:0+e.leftGoal.width+t.height/20,y:t.height/2-t.height/6+0,bounds:t,objArr:i}),e.player2=new r({x:t.width-e.player1.width-e.rightGoal.width-e.player1.width,y:t.height/2-e.player1.height/2+0,bounds:t,objArr:i}),e.gameObjects=i,e}(this.bounds),this.gameObjects=this.genConstants.gameObjects,"wide"==this.orientation?(this.offsetX=.5*(this.canvas.width-this.bounds.width),this.offsetY=.5*(this.canvas.height-this.bounds.height)):(this.offsetX=.5*(this.canvas.height-this.bounds.width),this.offsetY=.5*(this.canvas.width-this.bounds.height)),this.gameObjects.forEach(t=>{"narrow"==this.orientation&&(t.isFlipped=!0),t.BASE.x=t.x+=this.offsetX,t.BASE.y=t.y+=this.offsetY}),this.playerName=this.player,this.player=this.genConstants[this.player],this.socket.removeEventListener("message",this.initBoundaries),this.startGame()}else"END"==e[1]&&this.endGame()}startGame(){var t,e,i;this.WINNINGSCORE=9,this.RENDER_TIME=10,this.BUFFER_DELAY=100,t=this.socket,e=this.playerName,i={orientation:this.orientation},y=t,v=e,b=i.orientation||"wide",document.addEventListener("touchstart",x),document.addEventListener("touchend",C),document.addEventListener("keydown",S),document.addEventListener("keyup",P),this.socket.addEventListener("message",R),this.serverUpdateClock=setTimeout(this.update,this.BUFFER_DELAY),this.renderer.startRenderingGame(),this.helpButton.removeClickListener(),this.requeueButton.removeClickListener()}update(){let t=function(){if(!I)return;let t=B(),e=O();if(t<0||t===L.length-1)return L[length-1];{let i=L[t],s=L[t+1],n=(e-i.time)/(s.time-i.time),r={};return i={ball:i.ball,player1:i.player1,player2:i.player2},Object.keys(i).forEach(t=>{let e=i[t],h={};Object.keys(e).forEach(i=>{h[i]=e[i]+(s[t][i]-e[i])*n}),r[t]=h}),r.player1.pts=i.player1.pts,r.player2.pts=i.player2.pts,r}}(),e=this.genConstants;t&&Object.keys(t).forEach(i=>{let s=t[i];s={x:s.x*(this.bounds.width/(1e3*this.aspectRatio))+this.offsetX,y:s.y*(this.bounds.height/1e3)+this.offsetY,pts:s.pts},Object.keys(s).forEach(t=>{e[i][t]=s[t]})}),this.serverUpdateClock=setTimeout(this.update,this.RENDER_TIME)}endGame(){if(this.gameOver)return void console.trace("Endgame called, but already exectued");this.gameOver=!0;let t=this;t.gameCanvas||(t.gameCanvas=t.canvas.getContext("2d")),t.renderer.stopRenderingGame(),window.requestAnimationFrame(t.renderer.clearScreen),t.socket.removeEventListener("message",t.serverReady),t.socket.removeEventListener("message",t.initBoundaries),t.socket.removeEventListener("message",R),document.removeEventListener("touchstart",x),document.removeEventListener("touchend",C),document.removeEventListener("keydown",S),document.removeEventListener("keyup",P),t.startButton.removeClickListener(),t.helpButton.removeClickListener(),t.requeueButton.removeClickListener(),clearTimeout(t.serverUpdateClock),document.dispatchEvent(t.gameoverEvent)}requestEndGame(){this.socket.send("PG END")}onGameOver(t){document.addEventListener("gameover",t,{once:!0}),this.gameOverCB=t}removeGameOverListener(t){let e=t||this.gameOverCB;document.removeEventListener("gameover",e)}}const k={get refresh(){let t=new ArrayBuffer(2),e=new DataView(t);return e.setInt8(0,128),e.setInt8(1,131),t}},G={_commWS:null,_tolerance:20,_rightCurr:0,_rightTarg:0,_leftCurr:0,_leftTarg:0,setTarget:function(t,e){"MATCH"==t?t=this._leftTarg:"MATCH"==e&&(e=this._rightTarg),null!=t&&(this._rightTarg=t),null!=e&&(this._leftTarg=e),this.easeRight()},easeRight:function(){let t=G;if(Math.abs(t._rightCurr-t._rightTarg)<=t._tolerance)t._rightCurr=t._rightTarg;else{let e=Math.ceil((t._rightTarg-t._rightCurr)/4);t._rightCurr=t._rightCurr+e}t.easeLeft()},easeLeft:function(){if(Math.abs(this._leftCurr-this._leftTarg)<=this._tolerance)this._leftCurr=this._leftTarg;else{let t=Math.ceil((this._leftTarg-this._leftCurr)/4);this._leftCurr=Math.floor(this._leftCurr+t)}this.sendPayload()},sendPayload:function(){let t=this.createRoombaPayload(this._rightCurr,this._leftCurr);console.log("Leftie: "+this._leftCurr+"\tRightie: "+this._rightCurr),this._commWS.readyState==WebSocket.OPEN&&this._commWS.send(t),this._rightCurr==this._rightTarg&&this._leftCurr==this._leftTarg||setTimeout(this.easeRight,30)},createRoombaPayload:function(t,e){let i=new ArrayBuffer(5),s=new DataView(i);return s.setInt8(0,145),s.setInt16(1,e),s.setInt16(3,t),i}};class V{constructor(t){G._commWS=t,this.speedInterval=180,this.turnInterval=80,this.notPressed={W:!0,S:!0,A:!0,D:!0,R:!0},this.parseKeyDown=this.parseKeyDown.bind(this),this.parseKeyUp=this.parseKeyUp.bind(this)}startCapturingInput(){document.addEventListener("keydown",this.parseKeyDown),document.addEventListener("keyup",this.parseKeyUp)}stopCapturingInput(){document.removeEventListener("keydown",this.parseKeyDown),document.removeEventListener("keyup",this.parseKeyUp)}parseKeyDown(t){let e=this.speedInterval,i=this.turnInterval,s=this.notPressed;"KeyX"==t.code&&G.setTarget(0,0),"KeyR"==t.code&&s.R&&G._commWS.send(k.refresh),t.shiftKey&&(e=400,i=100),"KeyW"==t.code&&s.W&&(s.W=!1,G.setTarget(G._rightTarg+e,G._leftTarg+e)),"KeyS"==t.code&&s.S&&(s.S=!1,G.setTarget(G._rightTarg-e,G._leftTarg-e)),"KeyA"==t.code&&s.A&&(s.A=!1,G.setTarget(G._rightTarg-i,G._leftTarg+i)),"KeyD"==t.code&&s.D&&(s.D=!1,G.setTarget(G._rightTarg+i,G._leftTarg-i))}parseKeyUp(t){let e=this.notPressed;if("KeyX"==t.code&&G.setTarget(0,0),"KeyW"==t.code||"KeyS"==t.code){let i=this.speedInterval;"KeyW"==t.code?e.W=!0:"KeyS"==t.code&&(e.S=!0,i*=-1),e.A&&e.D?G.setTarget(0,0):G.setTarget(G._rightTarg-i,G._leftTarg-i)}else"KeyA"==t.code?(e.A=!0,G.setTarget(G._rightTarg+this.turnInterval,G._leftTarg-this.turnInterval)):"KeyD"==t.code&&(e.D=!0,G.setTarget(G._rightTarg-this.turnInterval,G._leftTarg+this.turnInterval))}relay_setTarget(t,e){G.setTarget(e,t)}}class N{constructor(t,e,i){this.canvas=t,this.joyCanvas=t.getContext("2d"),this.callback=e,this.cursorPos={x:0,y:0},this.drawSelf=!0,i?1==i.deferDrawing&&(this.drawSelf=!1):i={};let s=i.bgRadius||this.canvas.width/2,n=t=>this.canvas.height/2<t?n(t-5):t;this.bgRadius=n(s),this.smolRadius=i.smolRadius||this.bgRadius/2,this.bgColor=i.bgColor||"#c7c4b3",this.smolColor=i.smolColor||"#2c282b7c",this.drawEllipse=this.drawEllipse.bind(this),this.drawBG=this.drawBG.bind(this),this.process_touchStart=this.process_touchStart.bind(this),this.process_touchEnd=this.process_touchEnd.bind(this),this.updateJoystick=this.updateJoystick.bind(this),this.getCursorPos=this.getCursorPos.bind(this),this.draw=this.draw.bind(this),this.end=this.end.bind(this),this.canvas.addEventListener("touchstart",this.process_touchStart)}process_touchStart(t){t.preventDefault(),this.updateJoystick(t),this.canvas.addEventListener("touchmove",this.updateJoystick),this.canvas.addEventListener("touchend",this.process_touchEnd)}process_touchEnd(t){t.preventDefault(),this.cursorPos={x:0,y:0},this.updateJoystick()}getCursorPos(t){var e=this.canvas.getBoundingClientRect();return{x:e.left+this.canvas.width/2-t.touches[0].clientX,y:e.top+this.canvas.height/2-t.touches[0].clientY}}updateJoystick(t){t&&(this.cursorPos=this.getCursorPos(t)),this.callback(this.cursorPos.x,this.cursorPos.y),this.drawSelf&&window.requestAnimationFrame(this.draw)}draw(){this.drawSelf&&this.joyCanvas.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawBG(),this.drawEllipse(this.cursorPos.x,this.cursorPos.y,this.smolRadius,this.smolColor)}drawEllipse(t,e,i,s){var n=this.canvas.width/2-t,r=this.canvas.height/2-e;this.joyCanvas.beginPath(),this.joyCanvas.arc(n,r,i,0,2*Math.PI),this.joyCanvas.fillStyle=s,this.joyCanvas.fill()}drawBG(){this.drawEllipse(0,0,this.bgRadius,this.bgColor)}end(){this.canvas.removeEventListener("touchstart",this.process_touchStart),this.canvas.removeEventListener("touchmove",this.updateJoystick),this.canvas.removeEventListener("touchend",this.process_touchEnd)}}window.onload=()=>{applyToAllChildren(document.body,t=>{t.style.transition="all 1s",t.style.opacity=1});var t=document.getElementsByClassName("h264-Window")[0];t.width=window.innerWidth,t.height=window.innerHeight;var e=`wss://${document.location.host}/clientStream`,i=new WSAvcPlayer(t,"webgl",1,35);i.connect(e);let s=document.querySelector(".center-feed-container"),n=document.getElementsByClassName("side-column");var r=document.createElement("canvas");r.width=window.innerWidth,r.height=window.innerHeight;var h=!1,o=`wss://${document.location.hostname}/common`,a=new WebSocket(o),l=new V(a);let d,c,u=-1;a.addEventListener("open",(function(e){a.send("CLIENT"),a.addEventListener("message",(function(e){let o=e.data.split(" ");if("ID"==o[0])d=parseInt(o[1]),i.ws.send("ID "+d);else if("QU"==o[0]){let e=document.getElementById("status-indic"),i=document.getElementsByClassName("callout-title")[0];u=parseInt(o[1]),c=Date.now();let d=window.innerWidth<=window.innerHeight?"portrait":"landscape";u>0&&(l.stopCapturingInput(),null!=document.querySelector("#joystick")&&(console.log("removing joystick"),n[2].removeChild(g)),e.innerHTML="landscape"==d?"Position: "+(u+1):u+1,e.style.backgroundColor="#202336"),0==u?(null==g||document.querySelector("#joystick")||(console.log("Appending Joystick canvas"),n[2].appendChild(g)),l.startCapturingInput(),e.innerHTML="You're Up!",e.style.backgroundColor="#709455"):u<=2&&u>0?(null!=n[1].querySelector("joystick")&&n[1].removeChild(g),h&&(console.log("Up and closing pong"),h=!1,smoothlyReplace(t,r,s),i.style.opacity=e.style.opacity=1)):u>2&&(h||(h=!0,console.log("REQUESTINGPONG"),smoothlyReplace(r,t,s),r.width=window.innerWidth,r.height=window.innerHeight,new _(r,a,{mobile:isMobileTablet()}),i.style.opacity=e.style.opacity=.5))}else if("MSG"==o[0]){let t=document.getElementsByClassName("callout-title")[0];"LOW-BATT"==o[1]&&(t.innerHTML="No Gas"),"VIDEO-UNAVAILABLE"==o[1]&&(t.innerHTML="No Signal"),"VIDEO-STREAMING"==o[1]&&(t.innerHTML="Roomba Roamer")}}))}));var g;(document.addEventListener("gameover",(function(){console.log("Gameover found at index "+u),u>2&&h&&(console.log("requesting it again"),new _(r,a,{mobile:isMobileTablet()}))})),isMobileTablet())&&((g=document.createElement("canvas")).id="joystick",g.width=n[1].clientWidth/1.5,g.height=n[1].clientHeight/3,new N(g,(t,e)=>{l.relay_setTarget(e+t,e-t)}).updateJoystick())};new MenuButton(document.getElementById("button-menu"),"/articles/rr-landing",{showImmediately:!0}),new BackButton(document.getElementById("button-back"))}]);